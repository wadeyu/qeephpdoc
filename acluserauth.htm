<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>QeePHP/FleaPHP 开源开发框架 - 开源项目|模型行为插件|acluserauth - 支持cookie登陆的acluser</title>
<link rel="shortcut icon" href="/favicon.ico">
<link rel="stylesheet" type="text/css" href="base.css" tppabs="http://qeephp.com/qeephp/base.css" />
<link rel="stylesheet" type="text/css" href="jquery-ui-081120.css" tppabs="http://qeephp.com/qeephp/jquery-ui-081120.css" />
<script type="text/javascript" src="jquery-1.2.6.min.js" tppabs="http://qeephp.com/js/jquery-1.2.6.min.js"></script>
<script type="text/javascript" src="jquery-ui-1.5.3-081202.min.js" tppabs="http://qeephp.com/qeephp/jquery-ui-1.5.3-081202.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
});
</script>
</head>
<body>

<div id="page-wrapper">

<!-- header -->
<div id="header">
  <div class="container clearfix">
    <div id="header_nav">
      <ul id="navigation">
        <li class="first"><a href="projects.htm" tppabs="http://qeephp.com/projects">开源项目与插件</a></li>
        <li><a href="cases.htm" tppabs="http://qeephp.com/cases">应用展示</a></li>
        <li><a href="framework.htm" tppabs="http://qeephp.com/framework">框架</a></li>
        <li><a href="docs.htm" tppabs="http://qeephp.com/docs">文档</a></li>
	  </ul>
    </div>
  </div>
</div>
<!-- /header -->


<!-- core -->
<div id="core" class="clearfix">
  <div class="container clearfix">

    <!-- 左侧栏 -->

    <div id="subpage_sidebar" class="left">

      
<!-- user_controlpanel -->

<div id="user_controlpanel" class="box">

  
  <h4 class="yellow">用户控制面板</h4>

  <div class="box-cnt">
    <ul>
      <li>
        <a class="icn_login" href="logging.php-action=login.htm" tppabs="http://qeephp.com/bbs/logging.php?action=login">登录后发布项目和应用展示</a>
      </li>
      <li>
        <a class="icn_register" href="register.php.htm" tppabs="http://qeephp.com/bbs/register.php">注册为社区成员</a>
      </li>
    </ul>
  </div>

  
</div>

<!-- /user_controlpanel -->




      <!--
      <form id="sub_search_form" name="sub_search_form" action="/projects" method="get">
        <input type="text" class="txt" name="keyword" />
        <input type="submit" class="btn" name="Submit" value="搜索项目" />
      </form>
      -->

      
      
<!-- projects_categories -->

<div id="projects_categories" class="box">
  <h4 class="blue">开源项目分类</h4>

  <div class="box-cnt">
    <p>
            <a href="framework-1.htm" tppabs="http://qeephp.com/projects/search/cat/framework">框架</a>
            <a href="app.htm" tppabs="http://qeephp.com/projects/search/cat/app">综合应用</a>
            <a href="behavior.htm" tppabs="http://qeephp.com/projects/search/cat/behavior">模型行为插件</a>
            <a href="helper.htm" tppabs="http://qeephp.com/projects/search/cat/helper">助手</a>
            <a href="formview.htm" tppabs="http://qeephp.com/projects/search/cat/formview">表单视图脚本</a>
            <a href="tool.htm" tppabs="http://qeephp.com/projects/search/cat/tool">工具</a>
            <a href="example.htm" tppabs="http://qeephp.com/projects/search/cat/example">学习实例</a>
            <a href="security.htm" tppabs="http://qeephp.com/projects/search/cat/security">安全</a>
            <a href="db.htm" tppabs="http://qeephp.com/projects/search/cat/db">数据库</a>
            <a href="webcontrol.htm" tppabs="http://qeephp.com/projects/search/cat/webcontrol">用户界面控件</a>
          </p>

    <p>
      <a href="projects.htm" tppabs="http://qeephp.com/projects">查看全部类别的开源项目...</a>
    </p>
  </div>
</div>

<!-- /projects_categories -->



      
<!-- popular_projects -->

<div id="popular_projects" class="box">
  <h4><span class="right">[<a href="downloads_count-desc.htm" tppabs="http://qeephp.com/projects/index/order/downloads_count-desc">查看全部</a>]</span>最热门的项目</h4>
  <ul>

    
    <li>
      <a href="qeephp.htm" tppabs="http://qeephp.com/projects/qeephp" target="_blank">QeePHP 2.1.2560</a>
    </li>

    
    <li>
      <a href="apmxe.htm" tppabs="http://qeephp.com/projects/apmxe" target="_blank">APM Express 集成运行环境</a>
    </li>

    
    <li>
      <a href="community.htm" tppabs="http://qeephp.com/projects/community" target="_blank">QeePHP.com 社区平台</a>
    </li>

    
    <li>
      <a href="qeephp_2_1_2683.htm" tppabs="http://qeephp.com/projects/qeephp_2_1_2683" target="_blank">QeePHP V2.1 Build 2683</a>
    </li>

    
    <li>
      <a href="13blog.htm" tppabs="http://qeephp.com/projects/13blog" target="_blank">[视频教程]建立简单mvc blog</a>
    </li>

    
    <li>
      <a href="example_todo.htm" tppabs="http://qeephp.com/projects/example_todo" target="_blank">示例 todo</a>
    </li>

    
    <li>
      <a href="ds_blog.htm" tppabs="http://qeephp.com/projects/ds_blog" target="_blank">QeePHP简单例子Ds_Blog</a>
    </li>

    
    <li>
      <a href="qeephpbuild.htm" tppabs="http://qeephp.com/projects/qeephpbuild" target="_blank">QeePHP 专属生成工具</a>
    </li>

    
    <li>
      <a href="formview_simple.htm" tppabs="http://qeephp.com/projects/formview_simple" target="_blank">简单的表单视图</a>
    </li>

    
    <li>
      <a href="example_hello.htm" tppabs="http://qeephp.com/projects/example_hello" target="_blank">示例 HelloWorld</a>
    </li>

    
  </ul>
</div>

<!-- /popular_projects -->



      
<!-- ratings_projects -->

<div id="ratings_projects" class="box">
  <h4><span class="right">[<a href="rating-desc.htm" tppabs="http://qeephp.com/projects/index/order/rating-desc">查看全部</a>]</span>评价最高的项目</h4>
  <ul>

    
    <li>
      <a href="fleaphp.htm" tppabs="http://qeephp.com/projects/fleaphp" target="_blank">FleaPHP 1.7.1524</a>
    </li>

    
    <li>
      <a href="qeephp.htm" tppabs="http://qeephp.com/projects/qeephp" target="_blank">QeePHP 2.1.2560</a>
    </li>

    
    <li>
      <a href="qeephpbuild.htm" tppabs="http://qeephp.com/projects/qeephpbuild" target="_blank">QeePHP 专属生成工具</a>
    </li>

    
    <li>
      <a href="community.htm" tppabs="http://qeephp.com/projects/community" target="_blank">QeePHP.com 社区平台</a>
    </li>

    
    <li>
      <a href="pagination.htm" tppabs="http://qeephp.com/projects/pagination" target="_blank">Digg 样式的分页导航条</a>
    </li>

    
    <li>
      <a href="ds_blog.htm" tppabs="http://qeephp.com/projects/ds_blog" target="_blank">QeePHP简单例子Ds_Blog</a>
    </li>

    
    <li>
      <a href="acluserauth.htm" tppabs="http://qeephp.com/projects/acluserauth" target="_blank">acluserauth - 支持cookie登陆的acluser</a>
    </li>

    
    <li>
      <a href="formview_simple.htm" tppabs="http://qeephp.com/projects/formview_simple" target="_blank">简单的表单视图</a>
    </li>

    
    <li>
      <a href="apmxe.htm" tppabs="http://qeephp.com/projects/apmxe" target="_blank">APM Express 集成运行环境</a>
    </li>

    
    <li>
      <a href="example_todo.htm" tppabs="http://qeephp.com/projects/example_todo" target="_blank">示例 todo</a>
    </li>

    
  </ul>
</div>

<!-- /ratings_projects -->



      
<!-- recents_projects -->

<div id="recents_projects" class="box">
  <h4><span class="right">[<a href="updated-desc.htm" tppabs="http://qeephp.com/projects/index/order/updated-desc">查看全部</a>]</span>最近更新的项目</h4>
  <ul>

    
    <li>
      <a href="kenxuunittesting.htm" tppabs="http://qeephp.com/projects/kenxuunittesting" target="_blank">简易PHP5单元测试框架kenxu-unit/</a>
    </li>

    
    <li>
      <a href="qeephp_2_1_2683.htm" tppabs="http://qeephp.com/projects/qeephp_2_1_2683" target="_blank">QeePHP V2.1 Build 2683</a>
    </li>

    
    <li>
      <a href="xser-php-framework-0_11.htm" tppabs="http://qeephp.com/projects/xser-php-framework-0_11" target="_blank">xser-php-framework-0.11</a>
    </li>

    
    <li>
      <a href="xser-php-framework.htm" tppabs="http://qeephp.com/projects/xser-php-framework" target="_blank">xser php framework v0.1</a>
    </li>

    
    <li>
      <a href="cnny001.htm" tppabs="http://qeephp.com/projects/cnny001" target="_blank">中国农药第一网</a>
    </li>

    
    <li>
      <a href="aclusermore.htm" tppabs="http://qeephp.com/projects/aclusermore" target="_blank">AclUserMore1.0- 支持仿DISCUZ加密cookie登陆的acluser</a>
    </li>

    
    <li>
      <a href="06dengbangrong.htm" tppabs="http://qeephp.com/projects/06dengbangrong" target="_blank">学生作业</a>
    </li>

    
    <li>
      <a href="fleaphp-log-viewer.htm" tppabs="http://qeephp.com/projects/fleaphp-log-viewer" target="_blank">FleaPHP  开发日志查看器</a>
    </li>

    
    <li>
      <a href="qcache_ea.htm" tppabs="http://qeephp.com/projects/qcache_ea" target="_blank">QCache_EA</a>
    </li>

    
    <li>
      <a href="community.htm" tppabs="http://qeephp.com/projects/community" target="_blank">QeePHP.com 社区平台</a>
    </li>

    
  </ul>
</div>

<!-- /recents_projects -->



    </div>

    <!-- /左侧栏 -->

    <!-- 右侧栏 -->

    <div id="col3" class="right contents">

      
<!-- 项目详细信息 -->

<div class="project-show">

  <div class="projects-title">
    <img src="icn_project.gif" tppabs="http://qeephp.com/qeephp/icn_project.gif" />

    <h1>
      <a href="acluserauth.htm" tppabs="http://qeephp.com/projects/acluserauth">acluserauth - 支持cookie登陆的acluser</a>
                </h1>

    <p>
            作者：<a href="aligo.htm" tppabs="http://qeephp.com/projects/search/member/aligo">aligo</a>
          </p>
  </div>

  <div class="projects-contents">
    <ul class="meta clearfix">
      <li>分类：<a href="behavior.htm" tppabs="http://qeephp.com/projects/search/cat/behavior">模型行为插件</a></li>
      <li>最后更新：<strong>2009-01-15 15:47</strong></li>
      <li>下载次数：<strong class="hot">724</strong></li>
    </ul>

    <ul class="urls">
      <li class="project_url">项目网址：<a href="acluserauth.htm" tppabs="http://qeephp.com/projects/acluserauth">/projects/acluserauth</a></li>

      <li class="doc_url">在线文档：<a href="thread-5537-1-1.html" tppabs="http://qeephp.com/bbs/thread-5537-1-1.html">http://qeephp.com/bbs/thread-5537-1-1.html</a></li>

    </ul>

    <div class="formatted">
      
<p>最近开始研究QeePHP，发现很多东西很好很­强大很颠覆很非主流，决定下一个正式项目用Qe­ePHP做</p>

<p>最近几天在用QeePHP做一个示例性的东西，­算是熟悉一下QeePHP，先做用户注册登陆，­发现没办法cookie记忆登陆状态，于是就搞­了这个东西</p>

<p>主要实现cookie登陆记忆功能，原来a­cluser只能一次性ses­sion，现在是先检验ses­sion，找不到sessi­on从cookie里读取之前登陆时存入的­信息然后新建一个sessi­on</p>

<p>将原来里的行为插件由aclu­ser改成acluserau­th</p>

<p><code>// 指定该 ActiveRecord 要使用的行为插件<br />
‚behaviors‘ ⇒ ‚acluserauth‘,</code></p>

<p>模型行为插件Model_Be­havior_AclUse­rAuth是继承Model_Be­havior_AclUser的，</p>

<p>因为qeephp的模型行为插件没办法­扩展，为了简便只好这样</p>

<p>其实只是加了验证从cooki­e登陆的函数</p>

<p>放到model/behavior里</p>

<p>助手Helper_Auth::_au­thcode($strin­g, $operation = ‚DECODE‘, $key =
'', $expiry = 0)</p>

<p>用来加密解密储存到cooki­e里的数据，使用时需要在en­vironment.yam­l里指定acl_cooki­e_auth防止cooki­e被修改破译入侵</p>

<p><code># 指示 ACL 组件用什么加密cookie中的数据 acl_cookie_auth:
aligoloveloli</code></p>

<h2>使用举例</h2>

<p>在environment.y­aml必须有</p>

<p><code># 是否自动打开 session runtime_sessi­on_start:  true</code></p>

<p># 在 cookie 中使用什么名字保存应用程序的 session
session_cooki­e_name: todolost_</p>

<p># 指示 ACL 组件用什么加密cookie中的数据 acl_cookie_auth:
todolost_superaligo</p>

<p># 指示 ACL 组件的cookie作用路径 acl_cookie_path:
/todolost/public</p>

<p># 指示 ACL 组件用什么键名在 session 中保存用户数据
acl_session_key: acl_todolost_u­serdata </p>

<p>其中这里将session_co­okie_name作为co­okie前缀使用</p>

<h3>App（基于默认生成的my­app）里的的修改</h3>

<p>在function dispatching(array $args = array())里</p>

<p><code> // 检查是否有权限访问<br />
if (!$this-&gt;authorizedUDI($this-&gt;currentUserRo­les(), $udi))</code></p>

<p>的前面加入$this-&gt;user = $this-&gt;currentUser();
以后访问$this-&gt;currentUser();$this-&gt;_app-&gt;currentUser();之类的
直接用$this-&gt;user;$this-&gt;_app-&gt;user;</p>

<p>4个函数的修改：</p>

<h4>changeCurrentUser</h4>
<code></code>
<p>function changeCurrentU­ser($user, $roles, $password, $cookietime = 0)<br />
{ $user[‚roles‘] = implode(‚,‘, Q::normalize($ro­les));<br />
$_SESSION[Q::i­ni(‚acl_sessi­on_key‘)] = $user;<br />
if($cookietime){<br />
setcookie(Q::i­ni(‚session_co­okie_name‘).‚co­okietime‘, $cookietime,
9999999999, Q::ini(‚acl_co­okie_path‘));<br />
setcookie(Q::i­ni(‚session_co­okie_name‘).‚au­th‘,
Helper_Auth::_au­thcode(„$passwor­d\t$user[user­name]“, ‚ENCODE‘),
$cookietime, Q::ini(‚acl_co­okie_path‘));<br />
}<br />
} </p>

<h4>currentUser</h4>
<code></code>
<p>function currentUser()<br />
{<br />
$key = Q::ini(‚acl_ses­sion_key‘);<br />
if(!isset($this-&gt;user)&amp;&amp;(!isset($_SES­SION[$key]))){<br />
<acronym
title="isset($_COOKIE[Q::ini(‚session_cookie_name‘).‚auth‘]">if</acronym>&amp;&amp;(isset($_CO­OKIE[Q::ini(‚ses­sion_cookie_na­me‘).‚cookieti­me‘]))){<br
/>
$auth = $_COOKIE[Q::i­ni(‚session_co­okie_name‘).‚au­th‘];<br />
if($_COOKIE[Q::i­ni(‚session_co­okie_name‘).‚co­okietime‘] &gt;
time()){<br />
list($password, $username) = empty($auth) ? array('', '', 0) : explode(„\t“,
Helper_Auth::_au­thcode($auth, ‚DECODE‘));<br />
try{<br />
$user = User::meta()-&gt;validateCooki­eLogin($userna­me,$password);<br />
$users = $user-&gt;aclData();<br />
$users[‚roles‘] = implode(‚,‘, Q::normalize($user-&gt;aclRoles()));<br
/>
}catch (Exception $ex){<br />
$this-&gt;cleanCurrentU­ser();<br />
return $ex;<br />
}<br />
if(isset($user-&gt;id)){<br />
$_SESSION[$key] = $users;<br />
}<br />
}else{<br />
$this-&gt;cleanCurrentU­ser();<br />
}<br />
}<br />
}<br />
return isset($_SESSI­ON[$key]) ? $_SESSION[$key] : null;<br />
}</p>

<h4>currentUserRoles</h4>
<code></code>
<p>function currentUserRoles()<br />
{<br />
$user = $this-&gt;user;<br />
return isset($user[‚ro­les‘]) ? Q::normalize($u­ser[‚roles‘]) :
array();<br />
}</p>

<h4>cleanCurrentUser</h4>

<p><code> function cleanCurrentUser()<br />
{<br />
setcookie(Q::i­ni(‚session_co­okie_name‘).‚co­okietime‘, '', 0,
Q::ini(‚acl_co­okie_path‘));<br />
setcookie(Q::i­ni(‚session_co­okie_name‘).‚au­th‘, '', 0,
Q::ini(‚acl_co­okie_path‘));<br />
unset($_SESSI­ON[Q::ini(‚acl_ses­sion_key‘)]);<br />
}</code></p>

<h2>登陆实例</h2>

<p>原来验证通过一般是</p>

<p><code>
$this-&gt;_app-&gt;changeCurren­tUser($user-&gt;aclData(),$user-&gt;aclRoles()); </code></p>

<p>现在需要</p>

<p><code>
$this-&gt;_app-&gt;changeCurren­tUser($user-&gt;aclData(),$user-&gt;aclRoles(),$u­ser[‚password‘],$co­okietime); </code></p>

<p>其中$user[‚passwor­d‘]就是数据库里对应的pas­sword字段，是不可方向加密过­的，以后还要通过Helper_Au­th::_authcode可方向加密的就是这个­$cookietime是到期具体的时间戳</p>

<p>稍微测试了一下应该没有太大­问题，如有问题请回帖指出另外，感谢CCAV，感谢­QeePHP，感谢dual­face老大在下做一点小东西­全当抛砖引玉，希望QeeP­HP开源社区能越来越强大！</p>

<!-- by Texy2! -->    </div>

    <div id="google-adsense-block720" style="margin: 10px 0 10px 0; width: 690px; height: 90px; display: block; overflow: hidden;"></div>

    <hr />
  </div>


<!-- 列出已有的文件 -->

  <a name="list_files"></a>
  
  <div class="projects-files">

    <h2>已上传的文件</h2>

    <div id="files-tabs">

      <ul>
              <li><a href="#tab-E69CAAE58886E7BB84">未分组</a></li>
            </ul>

      
      <div id="tab-E69CAAE58886E7BB84">
                <p>
          说&nbsp;明：
            <span class="summary">附件里的2个文件，一个放到app/model/behavior里，一个放到app/helper里</span>
                    <br />

          文&nbsp;件：
            <a class="filename" href="9-2" tppabs="http://qeephp.com/projects/acluserauth/download/9">acluserauth.zip            (1.39 KB,
            上传日期：2009-01-15 15:41)</a>
            <br />
          统&nbsp;计：
            <span class="stats">
              865 天内下载了 724 次
            </span>
        </p>
              </div>

          </div>

  </div>

<script language="javascript">
$("#files-tabs > ul").tabs();
</script>


<!-- /列出已有的文件 -->

</div>

<!-- /项目详细信息 -->


    </div>

    <!-- /右侧栏 -->

  </div>
</div>
<!-- /core -->

<!-- footer -->
<div id="footer">
  <div id="breadcrumbs">
    <p>
      <a href="index.htm" tppabs="http://qeephp.com/">返回首页</a>
      &nbsp;&nbsp;
      <a href="projects.htm" tppabs="http://qeephp.com/projects">开源项目与插件</a>
      &nbsp;&nbsp;
      <a href="cases.htm" tppabs="http://qeephp.com/cases">应用展示</a>
      &nbsp;&nbsp;
      <a href="framework.htm" tppabs="http://qeephp.com/framework">框架</a>
      &nbsp;&nbsp;
      <a href="docs.htm" tppabs="http://qeephp.com/docs">文档</a>
      &nbsp;&nbsp;
      <a href="index-1.htm" tppabs="http://qeephp.com/bbs/">论坛</a>
    </p>
  </div>
</div>
<!-- /footer -->

</div>
<!-- /page-wrapper -->

</body>
